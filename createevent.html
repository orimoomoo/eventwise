<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Event | EventWise</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="styles/combined.css" />
</head>
<body class="bg-light">

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div id="sidebar" class="col-md-1 col-lg-2 bg-white border-end vh-100 position-fixed d-none d-md-block">
      <div style="width: 100%; height: 80px; overflow: hidden;">
        <img src="./images/Eventwise-removebg-preview.png" alt="EventWise Logo" class="mx-auto d-block" style="height: 120px; object-fit: cover;" />
      </div>
      <div class="pt-3">
        <ul class="nav flex-column">
          <li class="nav-item mb-3 px-3"><a href="./dashboard.html" class="btn btn-secondary w-100">Dashboard</a></li>
          <li class="nav-item mb-3 px-3"><a href="./create.html" class="btn btn-primary w-100">Create</a></li>
          <li class="nav-item mb-3 px-3"><a href="./events.html" class="btn btn-secondary w-100">Events</a></li>
        </ul>
      </div>
      <div class="px-3" style="position: absolute; bottom: 20px; width: calc(100% - 1.5rem);">
        <a href="settings.html" class="btn btn-secondary btn-outline-secondary w-100">Settings</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-9 offset-md-3 col-lg-10 offset-lg-2 pt-3 pb-5">
      <form id="eventForm" class="card p-4 shadow-sm bg-white">
        <h3 class="mb-4">Create New Event</h3>

        <!-- Event Name -->
        <div class="mb-3">
          <label for="eventName" class="form-label">Event Name</label>
          <input type="text" class="form-control" id="eventName" required placeholder="Enter event name" />
        </div>

        <!-- Event Description -->
        <div class="mb-3">
          <label for="eventDescription" class="form-label">Description</label>
          <textarea class="form-control" id="eventDescription" rows="3" placeholder="Enter event description"></textarea>
        </div>

        <!-- Image Upload -->
        <div class="mb-3">
          <label for="eventImage" class="form-label">Upload Image (optional)</label>
          <input type="file" class="form-control" id="eventImage" accept="image/*" onchange="previewImage(event)">
          <div class="mt-3">
            <img id="imagePreview" src="#" alt="Image preview" style="max-width: 200px; display: none;" />
          </div>
        </div>

        <!-- Task Section -->
        <div class="mb-3">
          <label for="taskInput" class="form-label">Tasks</label>
          <ul class="list-group mb-2" id="taskList"></ul>
          <div class="input-group">
            <input type="text" class="form-control" id="taskInput" placeholder="Add task name">
            <button type="button" class="btn btn-outline-primary" onclick="addTask()">Add Task</button>
          </div>
        </div>

        <!-- Submit -->
        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-success">Create Event</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  const tasks = [];

  function addTask() {
    const taskInput = document.getElementById("taskInput");
    const value = taskInput.value.trim();
    if (value) {
      tasks.push({ name: value, description: "", cost: 0, completed: false });

      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = value;
      document.getElementById("taskList").appendChild(li);
      taskInput.value = "";
    }
  }

  function previewImage(event) {
    const output = document.getElementById("imagePreview");
    output.src = URL.createObjectURL(event.target.files[0]);
    output.style.display = "block";
    output.onload = () => URL.revokeObjectURL(output.src);
  }

  document.getElementById("eventForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const token = localStorage.getItem("token");
    if (!token) {
      alert("You are not logged in.");
      return;
    }

    const name = document.getElementById("eventName").value;
    const description = document.getElementById("eventDescription").value;

    try {
      const eventRes = await fetch("http://localhost:8080/api/events", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ name, description, imageUrl: "" })
      });

      if (!eventRes.ok) {
        const msg = await eventRes.text();
        alert("Failed to create event: " + msg);
        return;
      }

      // const events = await fetch("http://localhost:8080/api/events", {
      //   headers: { "Authorization": `Bearer ${token}` }
      // }).then(res => res.json());

      // const latestEvent = events[events.length - 1];
      // const eventId = latestEvent.id;

      // for (const task of tasks) {
      //   await fetch(`http://localhost:8080/api/tasks/${eventId}`, {
      //     method: "POST",
      //     headers: {
      //       "Content-Type": "application/json",
      //       "Authorization": `Bearer ${token}`
      //     },
      //     body: JSON.stringify(task)
      //   });
      // }

      alert("Event and tasks created successfully!");
      window.location.href = "events.html";

    } catch (err) {
      alert(err.message);
      console.error(err);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
