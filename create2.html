<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Event | EventWise</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2>Create Event</h2>
  <form id="eventForm" enctype="multipart/form-data" class="card p-4 shadow-sm bg-white">
    <div class="mb-3">
      <label for="eventName" class="form-label">Event Name</label>
      <input type="text" class="form-control" id="eventName" name="name" required>
    </div>

    <div class="mb-3">
      <label for="eventDescription" class="form-label">Description</label>
      <textarea class="form-control" id="eventDescription" name="description"></textarea>
    </div>

    <div class="mb-3">
      <label for="eventImage" class="form-label">Upload Image</label>
      <input type="file" class="form-control" id="eventImage" name="image">
    </div>

    <div class="mb-3">
      <label class="form-label">Tasks</label>
      <ul id="taskList" class="list-group mb-2"></ul>
      <div class="input-group">
        <input type="text" id="taskInput" class="form-control" placeholder="Add a task">
        <button type="button" class="btn btn-outline-primary" onclick="addTask()">Add Task</button>
      </div>
    </div>

    <button type="submit" class="btn btn-success mt-3">Create Event</button>
  </form>
</div>

<script>
  const tasks = [];

  function addTask() {
    const input = document.getElementById('taskInput');
    const taskName = input.value.trim();
    if (taskName !== '') {
      tasks.push({ name: taskName });
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = taskName;
      document.getElementById('taskList').appendChild(li);
      input.value = '';
    }
  }

  document.getElementById('eventForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const token = localStorage.getItem('token');
    if (!token) {
      alert('You are not logged in.');
      return;
    }

    const formData = new FormData();
    const name = document.getElementById('eventName').value;
    const description = document.getElementById('eventDescription').value;
    const imageFile = document.getElementById('eventImage').files[0];

    const event = {
      name,
      description,
      imageUrl: "" // will be set by backend if image uploaded
    };

    formData.append('event', new Blob([JSON.stringify(event)], { type: 'application/json' }));
    if (imageFile) {
      formData.append('image', imageFile);
    }

    try {
      const res = await fetch('http://localhost:8080/api/events', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      if (!res.ok) {
        const text = await res.text();
        alert("Failed: " + text);
        return;
      }

      // fetch latest event
      const events = await fetch("http://localhost:8080/api/events", {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      }).then(res => res.json());

      const latest = events[events.length - 1];
      const eventId = latest.id;

      // upload tasks
      for (const task of tasks) {
        await fetch(`http://localhost:8080/api/tasks/${eventId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(task)
        });
      }

      alert("Event and tasks created!");
      window.location.href = "events.html";
    } catch (err) {
      console.error(err);
      alert("Error submitting form.");
    }
  });
</script>
</body>
</html>
